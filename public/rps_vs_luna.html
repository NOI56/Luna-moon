<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luna Rock Paper Scissors - VS Luna</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', 'Monaco', monospace;
      background: #0a0a0a;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
        linear-gradient(135deg, #0a0a0a 0%, #1a0a2e 50%, #16213e 100%);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
      color: #00ffff;
      position: relative;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0, 255, 255, 0.03) 2px,
          rgba(0, 255, 255, 0.03) 4px
        );
      pointer-events: none;
      z-index: 0;
    }

    .game-container {
      position: relative;
      z-index: 1;
      text-align: center;
      max-width: 800px;
      width: 100%;
      padding-top: 100px;
      margin-top: 20px;
    }

    h1 {
      font-size: 3rem;
      margin-bottom: 20px;
      text-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff;
      color: #00ffff;
    }

    .wallet-section {
      margin-bottom: 30px;
    }

    .wallet-btn {
      background: rgba(0, 255, 255, 0.1);
      border: none;
      color: #00ffff;
      padding: 12px 24px;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s;
      margin: 5px;
      font-family: 'Courier New', monospace;
    }

    .wallet-btn:hover {
      background: rgba(0, 255, 255, 0.2);
      box-shadow: 0 0 20px #00ffff;
    }

    .wallet-btn.hidden {
      display: none;
    }

    .wallet-info {
      margin: 15px 0;
      padding: 10px;
      background: rgba(0, 255, 255, 0.05);
      border: 1px solid #00ffff;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    /* Contract Address Section */
    .contract-section {
      background: rgba(0, 255, 255, 0.05);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }

    .contract-label {
      font-size: 1rem;
      color: #00ffff;
      margin-bottom: 15px;
      font-weight: bold;
      text-shadow: 0 0 5px #00ffff;
    }

    .contract-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .contract-input {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(0, 255, 255, 0.3);
      color: #00ffff;
      padding: 12px 20px;
      font-size: 0.9rem;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      min-width: 300px;
      max-width: 100%;
      flex: 1;
    }

    .contract-input:focus {
      outline: none;
      box-shadow: 0 0 15px #00ffff;
    }

    .contract-btn {
      padding: 12px 24px;
      font-size: 0.9rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Courier New', monospace;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .contract-btn-copy {
      background: linear-gradient(135deg, #ff6b35, #ff8c42);
      color: white;
      font-weight: bold;
    }

    .contract-btn-copy:hover {
      background: linear-gradient(135deg, #ff8c42, #ff6b35);
      box-shadow: 0 0 15px rgba(255, 107, 53, 0.5);
      transform: translateY(-2px);
    }

    .contract-btn-view {
      background: linear-gradient(135deg, #1a237e, #283593);
      color: white;
      font-weight: bold;
    }

    .contract-btn-view:hover {
      background: linear-gradient(135deg, #283593, #3949ab);
      box-shadow: 0 0 15px rgba(26, 35, 126, 0.5);
      transform: translateY(-2px);
    }

    .contract-warning {
      font-size: 0.85rem;
      color: #00ffff;
      opacity: 0.8;
      margin-top: 15px;
    }

    /* X DEX Links Section */
    .dex-links {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .dex-btn {
      padding: 15px 30px;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      white-space: nowrap;
    }

    .dex-btn-buy {
      background: linear-gradient(135deg, #ff6b35, #ff8c42);
      color: white;
    }

    .dex-btn-buy:hover {
      background: linear-gradient(135deg, #ff8c42, #ff6b35);
      box-shadow: 0 0 20px rgba(255, 107, 53, 0.6);
      transform: translateY(-2px);
    }

    .dex-btn-community {
      background: linear-gradient(135deg, #1a237e, #283593);
      color: white;
    }

    .dex-btn-community:hover {
      background: linear-gradient(135deg, #283593, #3949ab);
      box-shadow: 0 0 20px rgba(26, 35, 126, 0.6);
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .contract-input-group {
        flex-direction: column;
      }

      .contract-input {
        min-width: 100%;
      }

      .dex-links {
        flex-direction: column;
      }

      .dex-btn {
        width: 100%;
        justify-content: center;
      }
    }
    }

    .balance-check {
      margin: 15px 0;
      padding: 15px;
      border-radius: 8px;
      font-size: 1rem;
      border: 2px solid;
    }

    .balance-check.success {
      background: rgba(0, 255, 0, 0.1);
      border-color: #00ff00;
      color: #00ff00;
    }

    .balance-check.error {
      background: rgba(255, 0, 0, 0.1);
      border-color: #ff0000;
      color: #ff0000;
    }

    .balance-check.hidden {
      display: none;
    }

    .game-area {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 40px 0;
      gap: 20px;
    }

    .hand {
      text-align: center;
      flex: 1;
    }

    .hand-label {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #00ffff;
      text-shadow: 0 0 10px #00ffff;
    }

    .hand-icon {
      width: 200px;
      height: 200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .hand-icon img {
      max-width: 100%;
      max-height: 100%;
      filter: drop-shadow(0 0 20px #00ffff);
    }

    #playerHand img {
      transform: scaleX(1) rotate(90deg);
    }

    #lunaHand img {
      transform: scaleX(1) rotate(-90deg);
    }

    .hand-icon.cycling img {
      animation: pulse 0.15s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .vs {
      font-size: 4rem;
      color: #00ffff;
      text-shadow: 0 0 30px #00ffff, 0 0 60px #00ffff;
      font-weight: bold;
    }

    .player-choices {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
    }

    .choice-btn {
      width: 120px;
      height: 120px;
      background: rgba(0, 255, 255, 0.1);
      border: 3px solid #00ffff;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .choice-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 255, 255, 0.2));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .choice-btn:hover::before {
      opacity: 1;
    }

    .choice-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 30px #00ffff;
    }

    .choice-btn:active {
      transform: scale(0.95);
    }

    .choice-btn img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      position: relative;
      z-index: 1;
    }

    .choice-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .status {
      margin: 20px 0;
      font-size: 1.2rem;
      color: #00ffff;
      min-height: 30px;
    }

    .status.error {
      color: #ff0000;
    }

    .result {
      font-size: 2rem;
      margin: 20px 0;
      min-height: 50px;
      font-weight: bold;
    }

    .result.win {
      color: #00ff00;
      text-shadow: 0 0 20px #00ff00;
    }

    .result.lose {
      color: #ff0000;
      text-shadow: 0 0 20px #ff0000;
    }

    .result.tie {
      color: #ffff00;
      text-shadow: 0 0 20px #ffff00;
    }

    .countdown-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .countdown {
      font-size: 10rem;
      color: #00ffff;
      text-shadow: 0 0 50px #00ffff, 0 0 100px #00ffff;
      font-weight: bold;
      animation: pulse 1s infinite;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: none;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .back-link {
      /* Removed position/left/top to allow inline styles to work */
      color: #00ffff;
      text-decoration: none;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .back-link:hover {
      background: rgba(0, 255, 255, 0.1);
      box-shadow: 0 0 20px #00ffff;
    }
    
    /* Ensure mode navigation is always visible */
    #modeNavigation {
      position: fixed !important;
      top: 40px !important;
      left: 20px !important;
      z-index: 99999 !important;
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    #modeNavigation a {
      display: inline-block !important;
      visibility: visible !important;
      opacity: 1 !important;
      cursor: pointer !important;
    }
    
    #modeNavigation a:hover {
      box-shadow: 
        0 0 20px currentColor,
        0 0 40px currentColor,
        0 0 60px currentColor,
        inset 0 0 20px rgba(255, 255, 255, 0.1) !important;
      transform: scale(1.05) !important;
      text-shadow: 
        0 0 10px currentColor,
        0 0 20px currentColor,
        0 0 30px currentColor !important;
      background: rgba(0, 0, 0, 0.95) !important;
    }
    
    #modeNavigation a:active {
      box-shadow: 
        0 0 30px currentColor,
        0 0 60px currentColor,
        0 0 90px currentColor,
        inset 0 0 30px rgba(255, 255, 255, 0.2) !important;
      transform: scale(0.98) !important;
    }
    
    /* Neon Toggle Button */
    #neonToggle {
      position: fixed;
      top: 40px;
      right: 20px;
      z-index: 99999;
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #00ffff;
      color: #00ffff;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      transition: all 0.3s;
      backdrop-filter: blur(5px);
    }

    #neonToggle:hover {
      background: rgba(0, 255, 255, 0.2);
      box-shadow: 0 0 10px #00ffff;
    }

    /* Neon Off Styles */
    body.neon-off * {
      text-shadow: none !important;
      box-shadow: none !important;
      filter: none !important;
      animation: none !important;
    }

    body.neon-off .game-container::before {
      display: none !important;
    }

    body.neon-off body::before {
      opacity: 0.01 !important;
    }
  </style>
  <link rel="stylesheet" href="/css/notifications.css">
  <link rel="stylesheet" href="/css/referral.css">
  <link rel="stylesheet" href="/css/chat.css">
</head>
<body>
  <div id="modeNavigation" style="position: fixed !important; top: 40px !important; left: 20px !important; display: flex !important; gap: 10px; z-index: 99999 !important; flex-wrap: wrap; pointer-events: auto !important; visibility: visible !important; opacity: 1 !important;">
    <a href="/rps_vs_luna.html" id="vsLunaLink" style="color: #00ffff !important; text-decoration: none !important; padding: 10px 20px !important; border: 2px solid #00ffff !important; border-radius: 8px !important; transition: all 0.3s; background: rgba(0, 0, 0, 0.9) !important; backdrop-filter: blur(5px); display: inline-block !important; visibility: visible !important; opacity: 1 !important;">üéÆ VS Luna</a>
  
  <button id="neonToggle" title="Toggle Neon Effects">üí° Neon: ON</button>
    <a href="/rps_game.html" id="pvpLink" style="color: #00ffff !important; text-decoration: none !important; padding: 10px 20px !important; border: 2px solid #00ffff !important; border-radius: 8px !important; transition: all 0.3s; background: rgba(0, 0, 0, 0.9) !important; backdrop-filter: blur(5px); display: inline-block !important; visibility: visible !important; opacity: 1 !important;">Play PvP! Find</a>
    <a href="/rps_betting.html" id="bettingLink" style="color: #00ffff !important; text-decoration: none !important; padding: 10px 20px !important; border: 2px solid #00ffff !important; border-radius: 8px !important; transition: all 0.3s; background: rgba(0, 0, 0, 0.9) !important; backdrop-filter: blur(5px); display: inline-block !important; visibility: visible !important; opacity: 1 !important;">üí∞ Betting Mode</a>
    <a href="/group_chat.html" style="color: #00ffff !important; text-decoration: none !important; padding: 10px 20px !important; border: 2px solid #00ffff !important; border-radius: 8px !important; transition: all 0.3s; background: rgba(0, 255, 255, 0.2) !important; backdrop-filter: blur(5px); display: inline-block !important; visibility: visible !important; opacity: 1 !important; box-shadow: 0 0 15px rgba(0, 255, 255, 0.5) !important;">üí¨ Group Chat</a>
    <a href="/rps_leaderboard.html" style="color: #00ffff !important; text-decoration: none !important; padding: 10px 20px !important; border: 2px solid #00ffff !important; border-radius: 8px !important; transition: all 0.3s; background: rgba(0, 0, 0, 0.9) !important; backdrop-filter: blur(5px); display: inline-block !important; visibility: visible !important; opacity: 1 !important;">üèÜ Leaderboard</a>
    <a href="/rps_stats.html" style="color: #00ffff !important; text-decoration: none !important; padding: 10px 20px !important; border: 2px solid #00ffff !important; border-radius: 8px !important; transition: all 0.3s; background: rgba(0, 0, 0, 0.9) !important; backdrop-filter: blur(5px); display: inline-block !important; visibility: visible !important; opacity: 1 !important;">üìä Stats</a>
    <a href="/rps_history.html" style="color: #00ffff !important; text-decoration: none !important; padding: 10px 20px !important; border: 2px solid #00ffff !important; border-radius: 8px !important; transition: all 0.3s; background: rgba(0, 0, 0, 0.9) !important; backdrop-filter: blur(5px); display: inline-block !important; visibility: visible !important; opacity: 1 !important;">üìú Match History</a>
  </div>

  <div class="game-container">
    <h1>üéÆ VS Luna</h1>

    <div class="wallet-section">
      <button id="connectWalletBtn" class="wallet-btn">üîó Connect Phantom Wallet</button>
      <button id="disconnectWalletBtn" class="wallet-btn hidden">üîå Disconnect / Change Wallet</button>
      <div id="walletInfo" class="wallet-info hidden"></div>
      <div id="balanceCheck" class="balance-check hidden"></div>
      <div id="solBalanceDisplay" class="wallet-info hidden" style="margin-top: 10px; padding: 15px; background: rgba(0, 255, 255, 0.1); border: 1px solid #00ffff; border-radius: 8px; font-size: 0.9em; color: #00ffff;">
        <strong>üí∞ SOL Balance:</strong> <span id="solBalanceAmount">0.0000</span> SOL
      </div>
    </div>

    <!-- Quick Stats Section -->
    <div id="quickStatsSection" class="wallet-info hidden" style="margin-top: 15px; padding: 15px; background: rgba(0, 255, 255, 0.1); border: 1px solid #00ffff; border-radius: 8px; font-size: 0.9em; color: #00ffff;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <strong>üìä Your Stats (VS Luna):</strong>
        <a href="/rps_stats.html" style="color: #00ffff; text-decoration: underline; font-size: 0.85em; opacity: 0.8;">View Full Stats ‚Üí</a>
      </div>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;">
        <div>
          <div style="font-size: 1.3em; font-weight: bold; color: #00ffff;" id="quickWins">0</div>
          <div style="font-size: 0.8em; opacity: 0.8;">Wins</div>
        </div>
        <div>
          <div style="font-size: 1.3em; font-weight: bold; color: #ff0066;" id="quickLosses">0</div>
          <div style="font-size: 0.8em; opacity: 0.8;">Losses</div>
        </div>
        <div>
          <div style="font-size: 1.3em; font-weight: bold; color: #ffff00;" id="quickTies">0</div>
          <div style="font-size: 0.8em; opacity: 0.8;">Ties</div>
        </div>
        <div>
          <div style="font-size: 1.3em; font-weight: bold; color: #00ff00;" id="quickWinRate">0%</div>
          <div style="font-size: 0.8em; opacity: 0.8;">Win Rate</div>
        </div>
      </div>
    </div>

    <!-- Contract Address Section -->
    <div class="contract-section">
      <div class="contract-label">Contract Address:</div>
      <div class="contract-input-group">
        <input type="text" id="contractAddress" class="contract-input" readonly value="Loading...">
        <button class="contract-btn contract-btn-copy" onclick="copyContractAddress()">
          <span>üìã</span> Copy
        </button>
        <button class="contract-btn contract-btn-view" onclick="viewContractAddress()">
          <span>üîó</span> View
        </button>
      </div>
      <div class="contract-warning">Always verify the contract address before buying.</div>
    </div>

    <!-- X DEX Links Section -->
    <div class="dex-links">
      <a href="#" id="buyDexLink" class="dex-btn dex-btn-buy" target="_blank" onclick="openBuyDex(event)">
        <span>‚ö°</span> Buy Luna
      </a>
      <a href="#" id="communityLink" class="dex-btn dex-btn-community" target="_blank" onclick="openCommunity(event)">
        <span>ùïè</span> Join Community
      </a>
    </div>

    <div class="game-area">
      <div class="hand">
        <div class="hand-label">You</div>
        <div id="playerHand" class="hand-icon"></div>
      </div>
      <div class="vs">VS</div>
      <div class="hand">
        <div class="hand-label">Luna</div>
        <div id="lunaHand" class="hand-icon"></div>
      </div>
    </div>

    <div id="result" class="result"></div>

    <div class="controls">
      <div class="player-choices">
        <button class="choice-btn" data-choice="rock" id="rockBtn"></button>
        <button class="choice-btn" data-choice="paper" id="paperBtn"></button>
        <button class="choice-btn" data-choice="scissors" id="scissorsBtn"></button>
      </div>
      <div id="status" class="status"></div>
    </div>
    
    <div style="margin-top: 40px; text-align: center;">
      <a href="/rps_betting.html" style="color: #00ffff; text-decoration: none; padding: 15px 30px; border: 2px solid #00ffff; border-radius: 8px; transition: all 0.3s; display: inline-block; font-size: 1.1em;">üí∞ Betting Mode</a>
    </div>
  </div>


  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script>
    const API_BASE = window.location.origin;
    const RPS_MIN_BALANCE = 1000000; // 1M Luna tokens
    // Mint address will be read from backend (.env) automatically
    // No need to hardcode here
    
    let playerBalance = 0;
    let gameActive = false;
    let walletConnected = false;
    let walletPublicKey = null;

    // Real-time balance checking enabled
    const TEST_MODE = false; // Using real Luna token
    let balanceUpdateInterval = null;
    let solBalanceUpdateInterval = null;
    let solBalance = 0;
    let playerStats = null;

    // Sound Effects System
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    // Play sound effect
    function playSound(frequency, duration, type = 'sine', volume = 0.3) {
      try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = type;
        
        gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
      } catch (e) {
        console.error('[Sound] Error playing sound:', e);
      }
    }
    
    // Countdown sound (beep)
    function playCountdownSound() {
      playSound(800, 0.1, 'sine', 0.2);
    }
    
    // Win sound (cheer - multiple beeps)
    function playWinSound() {
      // Play multiple ascending notes
      playSound(523, 0.15, 'sine', 0.3); // C
      setTimeout(() => playSound(659, 0.15, 'sine', 0.3), 100); // E
      setTimeout(() => playSound(784, 0.2, 'sine', 0.4), 200); // G
      setTimeout(() => playSound(1047, 0.3, 'sine', 0.5), 350); // C (high)
    }
    
    // Lose sound (sad descending)
    function playLoseSound() {
      // Play descending notes
      playSound(523, 0.2, 'sine', 0.3); // C
      setTimeout(() => playSound(440, 0.2, 'sine', 0.3), 150); // A
      setTimeout(() => playSound(349, 0.3, 'sine', 0.4), 300); // F (low)
    }
    
    // Tie sound (neutral)
    function playTieSound() {
      // Play a neutral tone
      playSound(440, 0.2, 'sine', 0.25); // A
      setTimeout(() => playSound(440, 0.2, 'sine', 0.25), 200); // A again
    }

    // Hand images
    const HAND_IMAGES = {
      rock: '/public/images/hands/rock.png',
      paper: '/public/images/hands/paper.png',
      scissors: '/public/images/hands/scissors.png',
      default: '/public/images/hands/rock.png'
    };
    
    const HAND_EMOJIS = {
      rock: 'ü™®',
      paper: 'üìÑ',
      scissors: '‚úÇÔ∏è',
      default: 'üëã'
    };
    
    function getHandDisplay(choice) {
      const img = document.createElement('img');
      img.src = HAND_IMAGES[choice] || HAND_IMAGES.default;
      img.alt = choice || 'default';
      img.onerror = function() {
        this.parentElement.textContent = HAND_EMOJIS[choice] || HAND_EMOJIS.default;
      };
      return img;
    }

    function formatNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(2) + 'M';
      } else if (num >= 1000) {
        return (num / 1000).toFixed(2) + 'K';
      }
      return num.toString();
    }

    // Check Luna Token Balance
    async function checkLunaBalance() {
      const balanceCheck = document.getElementById('balanceCheck');
      if (!balanceCheck) return;
      
      balanceCheck.classList.remove('hidden');
      balanceCheck.className = 'balance-check';
      balanceCheck.innerHTML = '<span class="loading"></span> Checking balance...';

      if (!walletConnected || !walletPublicKey) {
        balanceCheck.className = 'balance-check error';
        balanceCheck.textContent = '‚ùå Please connect your Phantom wallet first!';
        disableGame();
        return;
      }

      // Check real balance from blockchain
      // Mint address will be read from backend (.env) automatically
      try {
        // Use backend API to check balance (bypasses RPC rate limiting)
        // Backend will read mint address from .env automatically
        const response = await fetch(`${API_BASE}/luna/rps/balance?wallet=${walletPublicKey}`);
        const data = await response.json();
        
        if (!data.ok) {
          throw new Error(data.error || 'Failed to check balance');
        }
        
        playerBalance = data.balance || 0;

        if (playerBalance >= RPS_MIN_BALANCE) {
          balanceCheck.className = 'balance-check success';
          balanceCheck.textContent = `‚úÖ Balance: ${formatNumber(playerBalance)} Luna (Ready to play!)`;
          enableGame();
        } else {
          balanceCheck.className = 'balance-check error';
          balanceCheck.textContent = `‚ùå Insufficient balance! You need at least ${formatNumber(RPS_MIN_BALANCE)} Luna tokens. Current: ${formatNumber(playerBalance)}`;
          disableGame();
        }
      } catch (error) {
        console.error('Balance check error:', error);
        balanceCheck.className = 'balance-check error';
        balanceCheck.textContent = `‚ùå Error checking balance: ${error.message}`;
        disableGame();
      }
    }

    // Start real-time balance updates
    function startBalanceUpdate() {
      // Clear existing interval if any
      if (balanceUpdateInterval) {
        clearInterval(balanceUpdateInterval);
      }
      
      // Update balance every 15 seconds (reduced frequency to avoid rate limiting)
      balanceUpdateInterval = setInterval(async () => {
        if (walletConnected && walletPublicKey) {
          await checkLunaBalance();
        }
      }, 15000);
    }

    // Stop real-time balance updates
    function stopBalanceUpdate() {
      if (balanceUpdateInterval) {
        clearInterval(balanceUpdateInterval);
        balanceUpdateInterval = null;
      }
    }

    // Check SOL Balance
    async function checkSolBalance() {
      const solBalanceDisplay = document.getElementById('solBalanceDisplay');
      const solBalanceAmount = document.getElementById('solBalanceAmount');
      
      if (!walletConnected || !walletPublicKey) {
        if (solBalanceDisplay) solBalanceDisplay.classList.add('hidden');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/luna/rps/sol/balance?wallet=${walletPublicKey}`);
        const data = await response.json();
        
        if (data.ok) {
          solBalance = data.balance || 0;
          if (solBalanceAmount) {
            solBalanceAmount.textContent = solBalance.toFixed(4);
          }
          if (solBalanceDisplay) {
            solBalanceDisplay.classList.remove('hidden');
          }
        } else {
          console.error('[VS Luna] SOL balance check error:', data.error);
        }
      } catch (err) {
        console.error('[VS Luna] SOL balance check error:', err);
      }
    }

    // Start real-time SOL balance updates
    function startSolBalanceUpdate() {
      // Clear existing interval if any
      if (solBalanceUpdateInterval) {
        clearInterval(solBalanceUpdateInterval);
      }
      
      // Update SOL balance every 10 seconds
      solBalanceUpdateInterval = setInterval(async () => {
        if (walletConnected && walletPublicKey) {
          await checkSolBalance();
        }
      }, 10000);
    }

    // Stop real-time SOL balance updates
    function stopSolBalanceUpdate() {
      if (solBalanceUpdateInterval) {
        clearInterval(solBalanceUpdateInterval);
        solBalanceUpdateInterval = null;
      }
    }

    function enableGame() {
      gameActive = true;
      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.classList.remove('disabled');
        btn.disabled = false;
      });
    }

    function disableGame() {
      gameActive = false;
      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.classList.add('disabled');
        btn.disabled = true;
      });
    }

    // Phantom Wallet Connection
    function setupWalletConnection() {
      const connectBtn = document.getElementById('connectWalletBtn');
      const disconnectBtn = document.getElementById('disconnectWalletBtn');
      const walletInfo = document.getElementById('walletInfo');
      
      if (!connectBtn) {
        console.error('[VS Luna] connectWalletBtn not found!');
        return;
      }

      if (!disconnectBtn) {
        console.error('[VS Luna] disconnectWalletBtn not found!');
        return;
      }
      
      // Check if Phantom wallet is available
      if (typeof window.solana === 'undefined' || !window.solana.isPhantom) {
        connectBtn.textContent = '‚ö†Ô∏è Phantom Wallet not found!';
        connectBtn.disabled = true;
        connectBtn.style.cursor = 'not-allowed';
        connectBtn.onclick = () => {
          alert('Please install Phantom wallet extension!\n\nDownload: https://phantom.app/');
        };
        return;
      }

      // Enable button
      connectBtn.disabled = false;
      connectBtn.style.cursor = 'pointer';
      
      connectBtn.addEventListener('click', async () => {
        try {
          if (!window.solana || !window.solana.isPhantom) {
            alert('Please install Phantom wallet extension!\n\nDownload: https://phantom.app/');
            return;
          }

          const response = await window.solana.connect();
          walletPublicKey = response.publicKey.toString();
          walletConnected = true;

          connectBtn.classList.add('hidden');
          disconnectBtn.classList.remove('hidden');
          walletInfo.textContent = `Wallet: ${walletPublicKey.substring(0, 8)}...${walletPublicKey.substring(walletPublicKey.length - 8)}`;
          walletInfo.classList.remove('hidden');

          await checkLunaBalance();
          await checkSolBalance();
          await loadQuickStats(); // Load player stats
          startBalanceUpdate(); // Start real-time balance updates
          startSolBalanceUpdate(); // Start real-time SOL balance updates
        } catch (error) {
          console.error('Wallet connection error:', error);
          alert('Failed to connect wallet: ' + error.message);
        }
      });

      disconnectBtn.addEventListener('click', async () => {
        try {
          if (window.solana && window.solana.isConnected) {
            await window.solana.disconnect();
          }
          
          walletPublicKey = null;
          walletConnected = false;
          playerBalance = 0;
          gameActive = false;

          stopBalanceUpdate(); // Stop real-time balance updates
          stopSolBalanceUpdate(); // Stop real-time SOL balance updates

          connectBtn.classList.remove('hidden');
          disconnectBtn.classList.add('hidden');
          walletInfo.classList.add('hidden');
          
          const balanceCheck = document.getElementById('balanceCheck');
          if (balanceCheck) {
            balanceCheck.classList.add('hidden');
          }
          
          disableGame();
        } catch (error) {
          console.error('Wallet disconnect error:', error);
          walletPublicKey = null;
          walletConnected = false;
          playerBalance = 0;
          connectBtn.classList.remove('hidden');
          disconnectBtn.classList.add('hidden');
          walletInfo.classList.add('hidden');
          disableGame();
        }
      });

      if (window.solana && window.solana.isPhantom) {
        window.solana.on('connect', async () => {
          walletPublicKey = window.solana.publicKey.toString();
          walletConnected = true;
          connectBtn.classList.add('hidden');
          disconnectBtn.classList.remove('hidden');
          walletInfo.textContent = `Wallet: ${walletPublicKey.substring(0, 8)}...${walletPublicKey.substring(walletPublicKey.length - 8)}`;
          walletInfo.classList.remove('hidden');
          await checkLunaBalance();
          await checkSolBalance();
          await loadQuickStats(); // Load player stats
          startBalanceUpdate(); // Start real-time balance updates
          startSolBalanceUpdate(); // Start real-time SOL balance updates
        });

        window.solana.on('disconnect', () => {
          stopBalanceUpdate(); // Stop real-time balance updates
          stopSolBalanceUpdate(); // Stop real-time SOL balance updates
          walletPublicKey = null;
          walletConnected = false;
          playerBalance = 0;
          connectBtn.classList.remove('hidden');
          disconnectBtn.classList.add('hidden');
          walletInfo.classList.add('hidden');
          disableGame();
        });

        if (window.solana.isConnected) {
          walletPublicKey = window.solana.publicKey.toString();
          walletConnected = true;
          connectBtn.classList.add('hidden');
          disconnectBtn.classList.remove('hidden');
          walletInfo.textContent = `Wallet: ${walletPublicKey.substring(0, 8)}...${walletPublicKey.substring(walletPublicKey.length - 8)}`;
          walletInfo.classList.remove('hidden');
          checkLunaBalance();
          checkSolBalance();
          loadQuickStats();
          startSolBalanceUpdate();
        }
      }
    }

    // Load Quick Stats
    async function loadQuickStats() {
      const quickStatsSection = document.getElementById('quickStatsSection');
      if (!quickStatsSection) return;

      if (!walletConnected || !walletPublicKey) {
        quickStatsSection.classList.add('hidden');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/luna/rps/stats?wallet=${walletPublicKey}`);
        const data = await response.json();

        if (data.ok && data.stats) {
          playerStats = data.stats;
          const stats = data.stats;

          // Filter VS Luna mode stats only (if mode-specific stats available)
          // For now, show all stats
          const wins = stats.wins || 0;
          const losses = stats.losses || 0;
          const ties = stats.draws || stats.ties || 0;
          const totalGames = stats.totalGames || (wins + losses + ties);
          const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(1) : 0;

          document.getElementById('quickWins').textContent = wins.toLocaleString();
          document.getElementById('quickLosses').textContent = losses.toLocaleString();
          document.getElementById('quickTies').textContent = ties.toLocaleString();
          document.getElementById('quickWinRate').textContent = winRate + '%';

          quickStatsSection.classList.remove('hidden');
        } else {
          quickStatsSection.classList.add('hidden');
        }
      } catch (error) {
        console.error('[VS Luna] Failed to load stats:', error);
        quickStatsSection.classList.add('hidden');
      }
    }

    // Initialize hands
    function initializeHands() {
      const playerHand = document.getElementById('playerHand');
      const lunaHand = document.getElementById('lunaHand');
      const rockBtn = document.getElementById('rockBtn');
      const paperBtn = document.getElementById('paperBtn');
      const scissorsBtn = document.getElementById('scissorsBtn');
      
      playerHand.appendChild(getHandDisplay('rock'));
      lunaHand.appendChild(getHandDisplay('rock'));
      
      if (rockBtn) {
        rockBtn.innerHTML = '';
        rockBtn.appendChild(getHandDisplay('rock'));
      }
      if (paperBtn) {
        paperBtn.innerHTML = '';
        paperBtn.appendChild(getHandDisplay('paper'));
      }
      if (scissorsBtn) {
        scissorsBtn.innerHTML = '';
        scissorsBtn.appendChild(getHandDisplay('scissors'));
      }
    }

    // Hand cycling animation
    let handCycleInterval = null;
    const handChoices = ['rock', 'paper', 'scissors'];
    let currentCycleIndex = 0;
    
    function startHandCycle(handElement) {
      if (handCycleInterval) {
        clearInterval(handCycleInterval);
      }
      
      currentCycleIndex = 0;
      handElement.classList.add('cycling');
      handCycleInterval = setInterval(() => {
        const choice = handChoices[currentCycleIndex];
        handElement.innerHTML = '';
        handElement.appendChild(getHandDisplay(choice));
        currentCycleIndex = (currentCycleIndex + 1) % handChoices.length;
      }, 150);
    }
    
    function stopHandCycle() {
      if (handCycleInterval) {
        clearInterval(handCycleInterval);
        handCycleInterval = null;
      }
    }

    // Play game with Luna
    async function playGame(playerChoice) {
      if (!gameActive) return;
      
      if (!walletConnected || !walletPublicKey) {
        const status = document.getElementById('status');
        status.textContent = 'Please connect your Phantom wallet first!';
        status.className = 'status error';
        return;
      }
      
      if (playerBalance < RPS_MIN_BALANCE) {
        const status = document.getElementById('status');
        status.textContent = `Insufficient balance! You need at least ${formatNumber(RPS_MIN_BALANCE)} Luna tokens.`;
        status.className = 'status error';
        await checkLunaBalance();
        return;
      }

      const status = document.getElementById('status');
      const result = document.getElementById('result');
      const playerHand = document.getElementById('playerHand');
      const lunaHand = document.getElementById('lunaHand');

      disableGame();
      status.textContent = '';
      result.textContent = '';

      playerHand.innerHTML = '';
      playerHand.appendChild(getHandDisplay(playerChoice));
      playerHand.classList.remove('animate', 'cycling');

      lunaHand.classList.add('cycling');
      startHandCycle(lunaHand);

      // Countdown 3-2-1
      const countdownOverlay = document.createElement('div');
      countdownOverlay.className = 'countdown-overlay';
      document.body.appendChild(countdownOverlay);

      const countdownNumbers = [3, 2, 1];
      let countdownIndex = 0;

      const showCountdown = () => {
        if (countdownIndex < countdownNumbers.length) {
          const countdownText = document.createElement('div');
          countdownText.className = 'countdown';
          countdownText.textContent = countdownNumbers[countdownIndex];
          countdownOverlay.innerHTML = '';
          countdownOverlay.appendChild(countdownText);
          // Play countdown sound for each number
          playCountdownSound();
          countdownIndex++;
          setTimeout(showCountdown, 1000);
        } else {
          countdownOverlay.remove();
          continueGame(playerChoice, playerHand, lunaHand, status, result);
        }
      };

      showCountdown();
    }

    async function continueGame(playerChoice, playerHand, lunaHand, status, result) {
      stopHandCycle();
      
      try {
        const response = await fetch(`${API_BASE}/luna/rps/play`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wallet: walletPublicKey || 'guest',
            choice: playerChoice,
            testMode: TEST_MODE // Send test mode flag to server
          })
        });

        const data = await response.json();
        
        if (!data.ok) {
          throw new Error(data.message || 'Game failed');
        }

        const lunaChoice = data.lunaChoice;
        lunaHand.innerHTML = '';
        lunaHand.appendChild(getHandDisplay(lunaChoice));
        lunaHand.classList.remove('cycling', 'animate');

        let finalResult = '';
        if (data.result === 'win') {
          finalResult = 'üéâ You Win!';
          result.className = 'result win';
          status.textContent = `Luna chose ${lunaChoice}. You win!`;
          playWinSound(); // Play win sound (cheer)
        } else if (data.result === 'lose') {
          finalResult = 'üò¢ You Lose!';
          result.className = 'result lose';
          status.textContent = `Luna chose ${lunaChoice}. You lose!`;
          playLoseSound(); // Play lose sound
        } else {
          finalResult = 'ü§ù Tie!';
          result.className = 'result tie';
          status.textContent = `Both chose ${lunaChoice}. It's a tie!`;
          playTieSound(); // Play tie sound
        }
        result.textContent = finalResult;

        // Update stats after game
        setTimeout(() => {
          loadQuickStats(); // Refresh stats display
        }, 1000);

        setTimeout(() => {
          enableGame();
          status.textContent = '';
          result.textContent = '';
          playerHand.innerHTML = '';
          playerHand.appendChild(getHandDisplay('rock'));
          lunaHand.innerHTML = '';
          lunaHand.appendChild(getHandDisplay('rock'));
        }, 3000);
      } catch (error) {
        console.error('Play game error:', error);
        stopHandCycle();
        status.textContent = `Error: ${error.message}`;
        status.className = 'status error';
        enableGame();
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          if (!gameActive || btn.classList.contains('disabled')) return;
          
          const choice = btn.dataset.choice;
          await playGame(choice);
        });
      });
    }

    // Navigation click sound (short beep)
    function playNavClickSound() {
      playSound(600, 0.1, 'sine', 0.2);
    }

    // Add click sound to navigation links
    function initNavigationSounds() {
      const navLinks = document.querySelectorAll('#modeNavigation a');
      navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          playNavClickSound();
          // Delay navigation to let sound play
          setTimeout(() => {
            window.location.href = link.href;
          }, 150);
        });
      });
    }

    // Neon Toggle System
    function initNeonToggle() {
      const neonToggle = document.getElementById('neonToggle');
      const body = document.body;
      
      // Load saved preference
      const neonEnabled = localStorage.getItem('neonEnabled') !== 'false';
      
      if (!neonEnabled) {
        body.classList.add('neon-off');
        neonToggle.textContent = 'üí° Neon: OFF';
      } else {
        body.classList.remove('neon-off');
        neonToggle.textContent = 'üí° Neon: ON';
      }
      
      neonToggle.addEventListener('click', () => {
        const isOff = body.classList.contains('neon-off');
        
        if (isOff) {
          body.classList.remove('neon-off');
          neonToggle.textContent = 'üí° Neon: ON';
          localStorage.setItem('neonEnabled', 'true');
        } else {
          body.classList.add('neon-off');
          neonToggle.textContent = 'üí° Neon: OFF';
          localStorage.setItem('neonEnabled', 'false');
        }
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      initNeonToggle();
      initNavigationSounds();
      setupWalletConnection();
      setupEventListeners();
      initializeHands();
      loadContractAddress();
    });

    // Load contract address from backend
    async function loadContractAddress() {
      try {
        const response = await fetch(`${API_BASE}/luna/rps/contract-address`);
        const data = await response.json();
        
        if (data.ok && data.contractAddress) {
          const contractInput = document.getElementById('contractAddress');
          if (contractInput) {
            contractInput.value = data.contractAddress;
          }
          
          // Update buy DEX link from env
          const buyDexLink = document.getElementById('buyDexLink');
          if (buyDexLink && data.buyLink) {
            buyDexLink.href = data.buyLink;
          } else if (buyDexLink) {
            // Fallback to pump.fun if buyLink not provided
            buyDexLink.href = `https://pump.fun/${data.contractAddress}`;
          }
          
          // Update X/Twitter community link from env
          const communityLink = document.getElementById('communityLink');
          if (communityLink && data.xLink) {
            communityLink.href = data.xLink;
          }
        }
      } catch (error) {
        console.error('Failed to load contract address:', error);
        const contractInput = document.getElementById('contractAddress');
        if (contractInput) {
          contractInput.value = 'Error loading address';
        }
      }
    }

    // Copy contract address to clipboard
    function copyContractAddress() {
      const contractInput = document.getElementById('contractAddress');
      if (contractInput) {
        contractInput.select();
        contractInput.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        const btn = event.target.closest('.contract-btn-copy');
        if (btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span>‚úì</span> Copied!';
          setTimeout(() => {
            btn.innerHTML = originalText;
          }, 2000);
        }
      }
    }

    // View contract address on Solscan
    function viewContractAddress() {
      const contractInput = document.getElementById('contractAddress');
      if (contractInput && contractInput.value && contractInput.value !== 'Loading...' && contractInput.value !== 'Error loading address') {
        window.open(`https://solscan.io/token/${contractInput.value}`, '_blank');
      }
    }

    // Open buy DEX link
    function openBuyDex(event) {
      event.preventDefault();
      const buyDexLink = document.getElementById('buyDexLink');
      if (buyDexLink && buyDexLink.href && buyDexLink.href !== '#') {
        window.open(buyDexLink.href, '_blank');
      } else {
        alert('Contract address not loaded yet. Please wait a moment and try again.');
      }
    }

    // Open community link (X/Twitter)
    function openCommunity(event) {
      event.preventDefault();
      const communityLink = document.getElementById('communityLink');
      if (communityLink && communityLink.href && communityLink.href !== '#') {
        window.open(communityLink.href, '_blank');
      } else {
        alert('Community link not loaded yet. Please wait a moment and try again.');
      }
    }
  </script>
  <script src="/js/notifications.js"></script>
  <script src="/js/referral.js"></script>
  <script src="/js/chat.js"></script>
  <script>
    // Initialize UI components immediately (will work with or without wallet)
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        // Initialize Notification System (show button even without wallet)
        if (typeof notificationManager !== 'undefined') {
          notificationManager.createUI();
        }
        
        // Initialize Referral System (show UI even without wallet)
        if (typeof referralManager !== 'undefined') {
          referralManager.createUI();
        }
        
        // Initialize Chat System (show chat even without wallet)
        if (typeof chatManager !== 'undefined') {
          chatManager.init(null);
          chatManager.createUI('vs_luna_page', 'lobby');
        }
      }, 500);
    });
    
    // Initialize UI components when wallet is available
    function initializeUIComponents() {
      const wallet = walletPublicKey || window.walletPublicKey || localStorage.getItem('walletAddress');
      if (wallet) {
        if (typeof notificationManager !== 'undefined') notificationManager.init(wallet);
        if (typeof referralManager !== 'undefined') referralManager.init(wallet);
        if (typeof chatManager !== 'undefined') {
          chatManager.init(wallet);
          const chatInput = document.getElementById('chat-input');
          if (chatInput) {
            chatInput.disabled = false;
            chatInput.placeholder = 'Type a message...';
          }
        }
      }
    }
    
    // Hook into wallet connection
    const originalConnectWallet = window.connectWallet;
    if (originalConnectWallet) {
      window.connectWallet = async function() {
        const result = await originalConnectWallet();
        setTimeout(initializeUIComponents, 500);
        return result;
      };
    }
    
    setTimeout(() => initializeUIComponents(), 1500);
  </script>
</body>
</html>

